<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Caixa</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .cliente-search {
            position: relative;
        }
        
        .cliente-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .cliente-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .cliente-item:hover {
            background: #f0f0f0;
        }
        
        .btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .btn-add-payment {
            background: #28a745;
            margin-left: 10px;
        }
        
        .btn-add-payment:hover {
            background: #218838;
        }
        
        .btn-remove-payment {
            background: #dc3545;
            margin-left: 5px;
        }
        
        .btn-remove-payment:hover {
            background: #c82333;
        }
        
        .pagamento-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .pagamento-item select {
            flex: 1;
            min-width: 220px;
        }

        .pagamento-item .payment-amount {
            width: 160px;
        }
        
        .valor-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .valor-item label {
            min-width: 120px;
            font-weight: bold;
            color: #555;
        }
        
        .valor-item input {
            flex: 1;
        }
        
        .payment-amount[readonly] {
            background-color: #f8f9fa;
            color: #28a745;
            font-weight: bold;
            cursor: not-allowed;
        }
        
        .payment-amount[readonly].valor-negativo {
            color: #dc3545;
            background-color: #f8d7da;
        }
        
        .payment-summary {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            text-align: right;
            font-size: 16px;
        }
        
        .payment-summary span {
            color: #28a745;
        }
        
        /* Estilos para Modais */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            animation: slideIn 0.3s ease;
            position: relative;
            margin: 20px;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .modal-title {
            margin: 0;
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .modal-close:hover {
            background-color: #f8f9fa;
            color: #000;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            flex-shrink: 0;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                transform: translateY(-50px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-small { max-width: 400px; }
        .modal-medium { max-width: 600px; }
        .modal-large { max-width: 800px; }
        .modal-full { max-width: 95%; }

        body.modal-open {
            overflow: hidden;
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .modal-container {
                max-width: 95%;
                margin: 10px;
            }
            
            .modal-header,
            .modal-body,
            .modal-footer {
                padding: 15px;
            }
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .produto-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            margin-bottom: 10px;
            background: white;
        }
        
        .produto-info {
            flex: 1;
        }
        
        .produto-nome {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .produto-detalhes {
            font-size: 14px;
            color: #666;
        }
        
        .produto-acoes {
            display: flex;
            gap: 5px;
        }
        
        .btn-editar, .btn-excluir {
            padding: 5px 10px;
            font-size: 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .btn-editar {
            background: #ffc107;
            color: #333;
        }
        
        .btn-editar:hover {
            background: #e0a800;
        }
        
        .btn-excluir {
            background: #dc3545;
            color: white;
        }
        
        .btn-excluir:hover {
            background: #c82333;
        }
        
        .navigation {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .navigation a {
            color: #007bff;
            text-decoration: none;
            margin: 0 15px;
            font-weight: bold;
        }
        
        .navigation a:hover {
            text-decoration: underline;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Controle de Caixa</h1>
        
        <div class="navigation">
            <a href="/">Registrar Venda</a>
            <a href="/relatorios">Admin</a>
            <a href="/configuracoes">Configurações</a>
        </div>
        
        <div id="messages"></div>
        
        <form id="transacao-form">
            <div class="form-group" id="campo_cliente_nome">
                <label for="cliente_nome">Cliente:</label>
                <div class="cliente-search">
                    <input type="text" id="cliente_nome" name="cliente_nome" placeholder="Digite o nome do cliente">
                    <div id="cliente-results" class="cliente-results" style="display: none;"></div>
                </div>
            </div>
            
            <div class="form-group" id="campo_produto_servico">
                <label for="produto_servico_id">Adicionar Produto/Serviço:</label>
                <div style="display: flex; gap: 10px; align-items: end;">
                    <select id="produto_servico_id" name="produto_servico_id" onchange="handleProdutoChange()" style="flex: 1;">
                        <option value="">Selecione um produto/serviço</option>
                        <option value="outro">Outro</option>
                        {% for produto in produtos %}
                        <option value="{{ produto.id }}" data-preco="{{ produto.price }}">{{ produto.name }} - R$ {{ "%.2f"|format(produto.price) }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" class="btn btn-small" onclick="adicionarProduto()">Adicionar</button>
                </div>
            </div>
            
            <div class="form-group" id="campo_outro_produto" style="display: none;">
                <label for="outro_produto_nome">Nome do Produto/Serviço:</label>
                <div style="display: flex; gap: 10px; align-items: end;">
                    <input type="text" id="outro_produto_nome" name="outro_produto_nome" placeholder="Digite o nome do produto/serviço" style="flex: 1;">
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <input type="checkbox" id="salvar_produto" style="width: auto;">
                        <label for="salvar_produto" style="margin: 0; white-space: nowrap;">Salvar na lista</label>
                    </div>
                </div>
            </div>
            
            <div class="form-group" id="campo_valor" style="display: none;">
                <label for="valor">Valor (R$):</label>
                <input type="number" id="valor" name="valor" step="0.01" min="0">
            </div>
            
            <div class="form-group" id="campo_lista_produtos">
                <label>Produtos Adicionados:</label>
                <div id="produtos-lista" style="border: 1px solid #ddd; border-radius: 5px; padding: 10px; min-height: 100px; background: #f9f9f9;">
                    <div id="produtos-vazios" style="text-align: center; color: #999; padding: 20px;">
                        Nenhum produto adicionado ainda. Selecione um produto acima e clique em "Adicionar".
                    </div>
                    <div id="produtos-container" style="display: none;"></div>
                </div>
            </div>
            
            <div class="form-group" id="campo_total_geral">
                <label>Total da Venda: <strong>R$ <span id="total-geral">0.00</span></strong></label>
            </div>
            
            <div class="form-group" id="campo_observacoes">
                <label for="observacoes">Observações:</label>
                <textarea id="observacoes" name="observacoes" rows="3" placeholder="Observações opcionais"></textarea>
            </div>
            
            <div class="form-group" id="campo_pagamentos">
                <label>Forma de Pagamento:</label>
                <div id="pagamentos-container">
                    <div class="pagamento-item">
                        <select class="payment-method" required onchange="handlePaymentMethodChange(this)">
                            <option value="">Selecione o método</option>
                        </select>
                        <button type="button" class="btn btn-small btn-add-payment" onclick="adicionarPagamento()">+</button>
                    </div>
                </div>
                <div id="pagamentos-valor-container" style="display: none; margin-top: 15px;">
                    <!-- Campos de valor aparecerão aqui -->
                </div>
                <div class="payment-summary">
                    <strong>Total: R$ <span id="payment-total">0.00</span></strong>
                </div>
            </div>
            
            <button type="submit" class="btn" id="btn-salvar" disabled>Salvar</button>
            <button type="button" class="btn btn-secondary" onclick="limparFormulario()">Limpar</button>
        </form>
    </div>
    
    <!-- Modal para editar produto -->
    <div id="modal-editar-produto" class="modal-overlay">
        <div class="modal-container modal-small">
            <div class="modal-header">
                <h3 class="modal-title">Editar Produto</h3>
                <button class="modal-close" onclick="fecharModalEditar()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="edit-produto-nome">Produto:</label>
                    <input type="text" id="edit-produto-nome" readonly>
                </div>
                <div class="form-group">
                    <label for="edit-produto-quantidade">Quantidade:</label>
                    <input type="number" id="edit-produto-quantidade" min="1" step="1" required>
                </div>
                <div class="form-group">
                    <label for="edit-produto-preco">Preço Unitário (R$):</label>
                    <input type="number" id="edit-produto-preco" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Subtotal: <strong>R$ <span id="edit-produto-subtotal">0.00</span></strong></label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="fecharModalEditar()">Cancelar</button>
                <button type="button" class="btn" onclick="salvarEdicaoProduto()">Salvar</button>
            </div>
        </div>
    </div>

    <script>
        let clienteSelecionado = null;
        let clienteFieldVisible = true;
        let produtosAdicionados = []; // Array para armazenar os produtos
        let produtoEditandoIndex = null; // Índice do produto sendo editado

        // Carregar configurações dos campos
        function carregarConfiguracoesCampos() {
            const salvos = localStorage.getItem('camposConfig');
            const camposConfig = salvos ? JSON.parse(salvos) : [
                { id: 'cliente_nome', nome: 'Nome do Cliente', descricao: 'Busca e seleção de clientes', visivel: true },
                { id: 'produto_servico', nome: 'Produto/Serviço', descricao: 'Lista de produtos e serviços disponíveis', visivel: true },
                { id: 'observacoes', nome: 'Observações', descricao: 'Notas adicionais sobre a venda', visivel: true }
            ];
            
            // Aplicar visibilidade dos campos
            camposConfig.forEach(campo => {
                const campoElement = document.getElementById(`campo_${campo.id}`);
                if (campoElement) {
                    campoElement.style.display = campo.visivel ? 'block' : 'none';
                }
            });
            
            // Campo valor sempre visível (obrigatório)
            const campoValor = document.getElementById('campo_valor');
            if (campoValor) {
                campoValor.style.display = 'block';
            }
            
            // Campo pagamentos sempre visível (obrigatório)
            const campoPagamentos = document.getElementById('campo_pagamentos');
            if (campoPagamentos) {
                campoPagamentos.style.display = 'block';
            }
        }

        // Carregar métodos de pagamento
        async function carregarMetodosPagamento() {
            try {
                const response = await fetch('/api/payment-methods');
                const methods = await response.json();
                
                // Atualizar todos os selects de pagamento
                document.querySelectorAll('.payment-method').forEach(select => {
                    select.innerHTML = '<option value="">Selecione o método</option>';
                    methods.forEach(method => {
                        const option = document.createElement('option');
                        option.value = method.id;
                        option.textContent = method.name;
                        option.style.color = method.color;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                console.error('Erro ao carregar métodos de pagamento:', error);
            }
        }

        // Função para adicionar produto à lista
        function adicionarProduto() {
            const select = document.getElementById('produto_servico_id');
            const produtoId = select.value;
            const outroNome = document.getElementById('outro_produto_nome').value;
            
            if (!produtoId) {
                showMessage('Selecione um produto/serviço!', 'error');
                return;
            }
            
            if (produtoId === 'outro' && !outroNome) {
                showMessage('Digite o nome do produto/serviço!', 'error');
                return;
            }
            
            let nomeProduto = '';
            let precoUnitario = 0;
            let produtoIdFinal = produtoId;
            
            if (produtoId === 'outro') {
                nomeProduto = outroNome;
                precoUnitario = parseFloat(document.getElementById('valor').value) || 0;
                
                // Validar preço para produtos "outro"
                if (precoUnitario <= 0) {
                    showMessage('Digite um valor válido para o produto!', 'error');
                    return;
                }
            } else {
                const selectedOption = select.options[select.selectedIndex];
                nomeProduto = selectedOption.text.split(' - R$ ')[0];
                precoUnitario = parseFloat(selectedOption.dataset.preco) || 0;
            }
            
            // Adicionar ao array
            const novoProduto = {
                id: produtoIdFinal,
                nome: nomeProduto,
                quantidade: 1,
                precoUnitario: precoUnitario,
                subtotal: precoUnitario
            };
            
            produtosAdicionados.push(novoProduto);
            
            // Limpar seleção
            select.value = '';
            
            // Limpar campos "outro" e remover required
            const outroCampo = document.getElementById('campo_outro_produto');
            const valorCampo = document.getElementById('campo_valor');
            const outroInput = document.getElementById('outro_produto_nome');
            const valorInput = document.getElementById('valor');
            
            outroCampo.style.display = 'none';
            valorCampo.style.display = 'none';
            outroInput.required = false;
            outroInput.value = '';
            valorInput.value = '';
            document.getElementById('salvar_produto').checked = false;
            
            // Atualizar interface
            renderizarProdutos();
            calcularTotalGeral();
            atualizarBotaoSalvar();
        }
        
        // Função para renderizar a lista de produtos
        function renderizarProdutos() {
            const container = document.getElementById('produtos-container');
            const vazios = document.getElementById('produtos-vazios');
            
            if (produtosAdicionados.length === 0) {
                container.style.display = 'none';
                vazios.style.display = 'block';
                return;
            }
            
            container.style.display = 'block';
            vazios.style.display = 'none';
            
            container.innerHTML = produtosAdicionados.map((produto, index) => `
                <div class="produto-item">
                    <div class="produto-info">
                        <div class="produto-nome">${produto.nome}</div>
                        <div class="produto-detalhes">
                            Quantidade: ${produto.quantidade} | 
                            Preço: R$ ${produto.precoUnitario.toFixed(2)} | 
                            Subtotal: R$ ${produto.subtotal.toFixed(2)}
                        </div>
                    </div>
                    <div class="produto-acoes">
                        <button class="btn-editar" onclick="editarProduto(${index})">Editar</button>
                        <button class="btn-excluir" onclick="excluirProduto(${index})">Excluir</button>
                    </div>
                </div>
            `).join('');
        }
        
        // Função para calcular o total geral
        function calcularTotalGeral() {
            const total = produtosAdicionados.reduce((soma, produto) => soma + produto.subtotal, 0);
            document.getElementById('total-geral').textContent = total.toFixed(2);
            
            // Atualizar total dos pagamentos
            document.getElementById('payment-total').textContent = total.toFixed(2);
            
            // Atualizar campos de valor dos pagamentos para usar o total geral
            const valorInputs = document.querySelectorAll('.payment-amount');
            const totalGeral = parseFloat(document.getElementById('total-geral').textContent) || 0;
            
            valorInputs.forEach(input => {
                if (input.hasAttribute('readonly')) {
                    input.value = totalGeral.toFixed(2);
                }
            });
        }
        
        // Função para atualizar estado do botão salvar
        function atualizarBotaoSalvar() {
            const btnSalvar = document.getElementById('btn-salvar');
            btnSalvar.disabled = produtosAdicionados.length === 0;
        }
        
        // Função para editar produto
        function editarProduto(index) {
            produtoEditandoIndex = index;
            const produto = produtosAdicionados[index];
            
            // Preencher modal
            document.getElementById('edit-produto-nome').value = produto.nome;
            document.getElementById('edit-produto-quantidade').value = produto.quantidade;
            document.getElementById('edit-produto-preco').value = produto.precoUnitario;
            document.getElementById('edit-produto-subtotal').textContent = produto.subtotal.toFixed(2);
            
            // Mostrar modal
            document.getElementById('modal-editar-produto').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        // Função para fechar modal de edição
        function fecharModalEditar() {
            document.getElementById('modal-editar-produto').style.display = 'none';
            document.body.style.overflow = 'auto';
            produtoEditandoIndex = null;
        }
        
        // Função para salvar edição de produto
        function salvarEdicaoProduto() {
            if (produtoEditandoIndex === null) return;
            
            const quantidade = parseInt(document.getElementById('edit-produto-quantidade').value);
            const precoUnitario = parseFloat(document.getElementById('edit-produto-preco').value);
            
            if (quantidade < 1 || !precoUnitario || precoUnitario < 0) {
                showMessage('Valores inválidos!', 'error');
                return;
            }
            
            // Atualizar produto
            produtosAdicionados[produtoEditandoIndex].quantidade = quantidade;
            produtosAdicionados[produtoEditandoIndex].precoUnitario = precoUnitario;
            produtosAdicionados[produtoEditandoIndex].subtotal = quantidade * precoUnitario;
            
            // Atualizar interface
            renderizarProdutos();
            calcularTotalGeral();
            fecharModalEditar();
        }
        
        // Função para excluir produto
        function excluirProduto(index) {
            if (confirm('Tem certeza que deseja excluir este produto?')) {
                produtosAdicionados.splice(index, 1);
                renderizarProdutos();
                calcularTotalGeral();
                atualizarBotaoSalvar();
            }
        }
        
        // Event listeners para o modal de edição
        document.getElementById('edit-produto-quantidade').addEventListener('input', function() {
            const quantidade = parseInt(this.value) || 0;
            const preco = parseFloat(document.getElementById('edit-produto-preco').value) || 0;
            document.getElementById('edit-produto-subtotal').textContent = (quantidade * preco).toFixed(2);
        });
        
        document.getElementById('edit-produto-preco').addEventListener('input', function() {
            const quantidade = parseInt(document.getElementById('edit-produto-quantidade').value) || 0;
            const preco = parseFloat(this.value) || 0;
            document.getElementById('edit-produto-subtotal').textContent = (quantidade * preco).toFixed(2);
        });

        // Lidar com mudança no campo de produto/serviço
        function handleProdutoChange() {
            const select = document.getElementById('produto_servico_id');
            const outroCampo = document.getElementById('campo_outro_produto');
            const outroInput = document.getElementById('outro_produto_nome');
            const valorCampo = document.getElementById('campo_valor');
            const valorInput = document.getElementById('valor');
            
            if (select.value === 'outro') {
                outroCampo.style.display = 'block';
                valorCampo.style.display = 'block';
                outroInput.required = true;
                outroInput.focus();
            } else {
                outroCampo.style.display = 'none';
                valorCampo.style.display = 'none';
                outroInput.required = false;
                outroInput.value = '';
                valorInput.value = '';
            }
        }

        // Lidar com mudança no método de pagamento
        function handlePaymentMethodChange(select) {
            atualizarCamposValor();
        }
        // Adicionar novo pagamento
        function adicionarPagamento() {
            const container = document.getElementById('pagamentos-container');
            const pagamentoItem = document.createElement('div');
            pagamentoItem.className = 'pagamento-item';
            
            // Clonar o primeiro select para manter as opções
            const firstSelect = document.querySelector('.payment-method');
            pagamentoItem.innerHTML = `
                <select class="payment-method" required onchange="handlePaymentMethodChange(this)">
                    ${firstSelect.innerHTML}
                </select>
                <button type="button" class="btn btn-small btn-remove-payment" onclick="removerPagamento(this)">-</button>
            `;
            
            container.appendChild(pagamentoItem);
            
            // Atualizar campos de valor
            atualizarCamposValor();
        }

        // Remover pagamento
        function removerPagamento(button) {
            const pagamentoItem = button.parentElement;
            pagamentoItem.remove();
            atualizarCamposValor();
        }

        // Atualizar campos de valor baseado nos métodos selecionados
        function atualizarCamposValor() {
            const rows = document.querySelectorAll('#pagamentos-container .pagamento-item');
            const valorContainer = document.getElementById('pagamentos-valor-container');
            const metodosSelecionados = [];

            // Limpar/ocultar o container antigo (não usamos mais, mas mantemos para compatibilidade)
            if (valorContainer) {
                valorContainer.innerHTML = '';
                valorContainer.style.display = 'none';
            }

            // Remover inputs existentes e coletar métodos selecionados na ordem das linhas
            rows.forEach(row => {
                const existingInput = row.querySelector('.payment-amount');
                if (existingInput) {
                    existingInput.remove();
                }

                const select = row.querySelector('.payment-method');
                if (select && select.value) {
                    metodosSelecionados.push({
                        row,
                        id: select.value,
                        name: select.options[select.selectedIndex].text
                    });
                }
            });

            if (metodosSelecionados.length === 0) {
                atualizarTotalPagamentos();
                return;
            }

            // Criar inputs ao lado de cada select selecionado
            // Regra: quando houver 2+ métodos, o primeiro fica calculado automaticamente (readonly)
            // e os demais ficam editáveis.
            metodosSelecionados.forEach((metodo, index) => {
                const input = document.createElement('input');

                input.type = 'number';
                input.className = 'payment-amount';
                input.dataset.methodId = metodo.id;
                input.dataset.methodIndex = String(index);
                input.step = '0.01';
                input.min = '0';

                // Regra: 1 método = sempre total (readonly). 2+ métodos = primeiro calculado (readonly)
                const shouldBeReadonly = (metodosSelecionados.length === 1) || (metodosSelecionados.length > 1 && index === 0);
                if (shouldBeReadonly) {
                    input.readOnly = true;
                    input.placeholder = metodosSelecionados.length === 1 ? 'Total' : 'Calculado automaticamente';
                } else {
                    input.required = true;
                    input.placeholder = 'Valor (R$)';
                    input.addEventListener('input', calcularValoresAutomaticos);
                    input.addEventListener('change', calcularValoresAutomaticos);
                }

                // Inserir antes do botão (+/-)
                const actionButton = metodo.row.querySelector('button');
                if (actionButton) {
                    metodo.row.insertBefore(input, actionButton);
                } else {
                    metodo.row.appendChild(input);
                }
            });

            // Preencher automaticamente se houver apenas um método
            if (metodosSelecionados.length === 1) {
                const totalGeral = parseFloat(document.getElementById('total-geral').textContent) || 0;
                const onlyInput = document.querySelector('.payment-amount');
                if (onlyInput) {
                    onlyInput.value = totalGeral.toFixed(2);
                }
            }

            calcularValoresAutomaticos();
            atualizarTotalPagamentos();
        }

        // Calcular valores automáticos
        function calcularValoresAutomaticos() {
            const valorInputs = document.querySelectorAll('.payment-amount');
            const totalGeral = parseFloat(document.getElementById('total-geral').textContent) || 0;

            if (valorInputs.length === 0) return;

            // Se há apenas um método, sempre usar o valor total geral
            if (valorInputs.length === 1) {
                valorInputs[0].value = totalGeral.toFixed(2);
                atualizarTotalPagamentos();
                return;
            }

            // Se há múltiplos métodos, calcular o PRIMEIRO como diferença do total geral
            let somaOutros = 0;
            valorInputs.forEach((input, index) => {
                if (index > 0) {
                    somaOutros += parseFloat(input.value) || 0;
                }
            });

            const primeiroInput = valorInputs[0];
            const valorPrimeiro = totalGeral - somaOutros;

            if (valorPrimeiro >= 0) {
                primeiroInput.value = valorPrimeiro.toFixed(2);
                primeiroInput.style.color = '#28a745';
                primeiroInput.classList.remove('valor-negativo');
            } else {
                primeiroInput.value = valorPrimeiro.toFixed(2);
                primeiroInput.style.color = '#dc3545';
                primeiroInput.classList.add('valor-negativo');
            }

            atualizarTotalPagamentos();
        }

        // Atualizar total dos pagamentos
        function atualizarTotalPagamentos() {
            const amounts = document.querySelectorAll('.payment-amount');
            let total = 0;
            
            amounts.forEach(input => {
                const value = parseFloat(input.value) || 0;
                total += value;
            });
            
            document.getElementById('payment-total').textContent = total.toFixed(2);
            
            // Verificar se o total corresponde ao valor da venda
            const totalGeral = parseFloat(document.getElementById('total-geral').textContent) || 0;
            const totalPagamentos = total;
            
            if (totalGeral > 0 && totalPagamentos > 0) {
                if (Math.abs(totalPagamentos - totalGeral) > 0.01) {
                    document.getElementById('payment-total').style.color = '#dc3545';
                } else {
                    document.getElementById('payment-total').style.color = '#28a745';
                }
            }
        }

        // Buscar clientes
        document.getElementById('cliente_nome').addEventListener('input', function(e) {
            const query = e.target.value;
            if (query.length < 2) {
                document.getElementById('cliente-results').style.display = 'none';
                return;
            }
            
            fetch(`/api/clients?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    const resultsDiv = document.getElementById('cliente-results');
                    resultsDiv.innerHTML = '';
                    
                    if (data.length > 0) {
                        resultsDiv.style.display = 'block';
                        data.forEach(cliente => {
                            const item = document.createElement('div');
                            item.className = 'cliente-item';
                            item.textContent = cliente.name;
                            item.onclick = () => selecionarCliente(cliente);
                            resultsDiv.appendChild(item);
                        });
                    } else {
                        resultsDiv.style.display = 'none';
                    }
                });
        });

        function selecionarCliente(cliente) {
            clienteSelecionado = cliente;
            document.getElementById('cliente_nome').value = cliente.name;
            document.getElementById('cliente-results').style.display = 'none';
        }


        // Auto-preencher valor quando selecionar produto
        document.getElementById('produto_servico_id').addEventListener('change', function(e) {
            const selectedOption = e.target.options[e.target.selectedIndex];
            const preco = selectedOption.getAttribute('data-preco');
            if (preco) {
                document.getElementById('valor').value = preco;
            }
        });

        // Enviar formulário
        // Função para salvar novo produto
        async function salvarNovoProduto(nome, preco) {
            try {
                const response = await fetch('/api/produtos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: nome,
                        price: preco
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showMessage(`Produto "${nome}" salvo com sucesso!`, 'success');
                    // Retornar o ID do produto salvo
                    return data.produto.id;
                } else {
                    showMessage('Erro ao salvar produto: ' + (data.error || 'Erro desconhecido'), 'error');
                    return null;
                }
            } catch (error) {
                showMessage('Erro ao salvar produto: ' + error, 'error');
                return null;
            }
        }

        document.getElementById('transacao-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validar se o campo valor está visível e preenchido
            const campoValor = document.getElementById('campo_valor');
            const valorInput = document.getElementById('valor');
            
            if (campoValor.style.display !== 'none' && (!valorInput.value || parseFloat(valorInput.value) <= 0)) {
                showMessage('O valor deve ser maior que zero!', 'error');
                valorInput.focus();
                return;
            }
            
            // Validar se há produtos adicionados
            if (produtosAdicionados.length === 0) {
                showMessage('Adicione pelo menos um produto!', 'error');
                return;
            }
            
            // Validar pagamentos
            const pagamentos = [];
            const valorInputs = document.querySelectorAll('.payment-amount');
            
            if (valorInputs.length === 0) {
                showMessage('Selecione pelo menos uma forma de pagamento!', 'error');
                return;
            }
            
            for (let input of valorInputs) {
                const value = parseFloat(input.value);

                // Campo calculado automaticamente (readOnly)
                if (input.readOnly) {
                    if (isNaN(value)) {
                        mostrarInformacao('Erro de Valores', 'Não foi possível calcular o valor automaticamente.');
                        return;
                    }
                    if (value < 0) {
                        mostrarInformacao('Erro de Valores', 'O valor total excede o somatório dos pagamentos informados!');
                        return;
                    }
                } else {
                    // Campos editáveis
                    if (!value || value <= 0) {
                        showMessage('Preencha todos os valores de pagamento!', 'error');
                        input.focus();
                        return;
                    }
                }

                pagamentos.push({
                    payment_method_id: parseInt(input.dataset.methodId),
                    amount: value
                });
            }
            
            // Validar se o total dos pagamentos corresponde ao valor da venda
            const totalPagamentos = pagamentos.reduce((sum, p) => sum + p.amount, 0);
            const valorVenda = parseFloat(document.getElementById('valor').value);
            
            if (Math.abs(totalPagamentos - valorVenda) > 0.01) {
                mostrarInformacao('Erro de Valores', 'O total dos pagamentos deve corresponder ao valor da venda!');
                return;
            }
            
            // Validação adicional: garantir que não há valores negativos calculados
            // (com 2+ métodos, o primeiro é o calculado automaticamente)
            const primeiroInput = valorInputs[0];
            if (primeiroInput && parseFloat(primeiroInput.value) < 0) {
                mostrarInformacao('Erro de Valores', 'O valor total excede o somatório dos pagamentos informados!');
                return;
            }
            
            // Salvar novos produtos se necessário
            for (let i = 0; i < produtosAdicionados.length; i++) {
                const produto = produtosAdicionados[i];
                if (produto.id === 'outro') {
                    const novoProdutoId = await salvarNovoProduto(produto.nome, produto.precoUnitario);
                    if (novoProdutoId) {
                        produtosAdicionados[i].id = novoProdutoId;
                    }
                }
            }
            
            // Preparar items para o backend
            const items = produtosAdicionados.map(produto => ({
                product_id: produto.id === 'outro' ? null : parseInt(produto.id),
                description: produto.id === 'outro' ? produto.nome : null,
                qty: produto.quantidade,
                unit_price: produto.precoUnitario,
                subtotal: produto.subtotal
            }));
            
            const totalGeral = produtosAdicionados.reduce((soma, produto) => soma + produto.subtotal, 0);
            
            const formData = {
                client_id: clienteSelecionado ? clienteSelecionado.id : null,
                total: totalGeral,
                notes: document.getElementById('observacoes').value,
                items: items,
                payments: pagamentos
            };
            
            fetch('/api/transaction', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Venda registrada com sucesso!', 'success');
                    limparFormulario();
                } else {
                    showMessage('Erro ao registrar venda: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showMessage('Erro ao registrar venda: ' + error, 'error');
            });
        });

        function limparFormulario() {
            document.getElementById('transacao-form').reset();
            clienteSelecionado = null;
            document.getElementById('cliente-results').style.display = 'none';
            
            // Resetar campo "outro" e remover required
            const outroCampo = document.getElementById('campo_outro_produto');
            const valorCampo = document.getElementById('campo_valor');
            const outroInput = document.getElementById('outro_produto_nome');
            const valorInput = document.getElementById('valor');
            
            outroCampo.style.display = 'none';
            valorCampo.style.display = 'none';
            outroInput.required = false;
            outroInput.value = '';
            valorInput.value = '';
            document.getElementById('salvar_produto').checked = false;
            
            // Resetar produtos
            produtosAdicionados = [];
            renderizarProdutos();
            calcularTotalGeral();
            atualizarBotaoSalvar();
            
            // Resetar pagamentos para um único item vazio
            const container = document.getElementById('pagamentos-container');
            container.innerHTML = `
                <div class="pagamento-item">
                    <select class="payment-method" required onchange="handlePaymentMethodChange(this)">
                        <option value="">Selecione o método</option>
                    </select>
                    <button type="button" class="btn btn-small btn-add-payment" onclick="adicionarPagamento()">+</button>
                </div>
            `;
            
            // Resetar container de valores
            document.getElementById('pagamentos-valor-container').innerHTML = '';
            document.getElementById('pagamentos-valor-container').style.display = 'none';
            
            // Resetar total
            document.getElementById('payment-total').textContent = '0.00';
            document.getElementById('payment-total').style.color = '#28a745';
            
            // Recarregar métodos de pagamento
            carregarMetodosPagamento();
        }

        function showMessage(message, type) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;
            messagesDiv.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Fechar resultados de cliente ao clicar fora
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.cliente-search')) {
                document.getElementById('cliente-results').style.display = 'none';
            }
        });
        
        // Fechar modal ao clicar fora
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('modal-editar-produto');
            if (e.target === modal) {
                fecharModalEditar();
            }
        });
        
        // Carregar configurações ao iniciar
        document.addEventListener('DOMContentLoaded', function() {
            carregarConfiguracoesCampos();
            carregarMetodosPagamento();
            
            // Inicializar interface
            renderizarProdutos();
            calcularTotalGeral();
            atualizarBotaoSalvar();
        });
        
        // Sistema de Modais
        function abrirModal(titulo, conteudo, botoes = [], tamanho = 'medium') {
            const overlay = document.querySelector('.modal-overlay');
            const container = document.querySelector('.modal-container');
            const titleElement = container.querySelector('.modal-title');
            const bodyElement = container.querySelector('.modal-body');
            const footerElement = container.querySelector('.modal-footer');
            
            // Definir título (mostrar apenas se houver)
            if (titulo) {
                titleElement.textContent = titulo;
                titleElement.style.display = 'block';
            } else {
                titleElement.style.display = 'none';
            }
            
            // Definir conteúdo
            if (typeof conteudo === 'string') {
                bodyElement.innerHTML = conteudo;
            } else {
                bodyElement.innerHTML = '';
                bodyElement.appendChild(conteudo);
            }
            
            // Definir tamanho
            container.className = `modal-container modal-${tamanho}`;
            
            // Adicionar botões
            footerElement.innerHTML = '';
            footerElement.style.display = 'flex';
            if (botoes.length > 0) {
                botoes.forEach(botao => {
                    const button = document.createElement('button');
                    button.textContent = botao.texto;
                    button.className = botao.classe || 'btn';
                    button.onclick = botao.onclick;
                    if (botao.tipo) button.type = botao.tipo;
                    footerElement.appendChild(button);
                });
            } else {
                footerElement.style.display = 'none';
            }
            
            // Mostrar modal
            overlay.style.display = 'flex';
            document.body.classList.add('modal-open');
            
            // Foco no primeiro elemento focável
            setTimeout(() => {
                const primeiroFocavel = container.querySelector('input, button, select, textarea');
                if (primeiroFocavel) primeiroFocavel.focus();
            }, 100);
        }
        
        function fecharModal() {
            const overlay = document.querySelector('.modal-overlay');
            overlay.style.display = 'none';
            document.body.classList.remove('modal-open');
        }
        
        function confirmarAcao(mensagem, callback, titulo = 'Confirmar Ação') {
            const botoes = [
                {
                    texto: 'Cancelar',
                    classe: 'btn btn-secondary',
                    onclick: () => fecharModal()
                },
                {
                    texto: 'Confirmar',
                    classe: 'btn btn-danger',
                    onclick: () => {
                        callback();
                        fecharModal();
                    }
                }
            ];
            
            abrirModal(titulo, `<p>${mensagem}</p>`, botoes, 'small');
        }
        
        function mostrarInformacao(titulo, mensagem, callback = null) {
            const botoes = callback ? [
                {
                    texto: 'OK',
                    classe: 'btn btn-primary',
                    onclick: () => {
                        callback();
                        fecharModal();
                    }
                }
            ] : [
                {
                    texto: 'OK',
                    classe: 'btn btn-primary',
                    onclick: () => fecharModal()
                }
            ];
            
            abrirModal(titulo, `<p>${mensagem}</p>`, botoes, 'small');
        }
        
        // Fechar modal ao clicar no overlay
        document.addEventListener('DOMContentLoaded', function() {
            const overlay = document.querySelector('.modal-overlay');
            if (overlay) {
                overlay.addEventListener('click', function(e) {
                    if (e.target === this) {
                        fecharModal();
                    }
                });
            }
        });
        
        // Fechar modal com ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const overlay = document.querySelector('.modal-overlay');
                if (overlay && overlay.style.display === 'flex') {
                    fecharModal();
                }
            }
        });
    </script>
    
    <!-- Modal Container -->
    <div class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title" style="display: none;">Título</h3>
                <button class="modal-close" onclick="fecharModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Conteúdo será inserido dinamicamente -->
            </div>
            <div class="modal-footer">
                <!-- Botões serão inseridos dinamicamente -->
            </div>
        </div>
    </div>
</body>
</html>
