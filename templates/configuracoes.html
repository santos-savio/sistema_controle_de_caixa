<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurações - Controle de Caixa</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .navigation {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .navigation a {
            color: #007bff;
            text-decoration: none;
            margin: 0 15px;
            font-weight: bold;
        }
        
        .navigation a:hover {
            text-decoration: underline;
        }
        
        .config-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .config-section h3 {
            color: #555;
            margin-bottom: 15px;
        }
        
        .field-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .field-item:last-child {
            border-bottom: none;
        }
        
        .field-info {
            flex: 1;
        }
        
        .field-name {
            font-weight: bold;
            color: #333;
        }
        
        .field-description {
            font-size: 14px;
            color: #666;
        }
        
        .field-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .field-controls > div {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .field-controls input:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .field-controls input:disabled + .slider {
            background-color: #007bff;
            cursor: not-allowed;
        }
        
        .field-controls small {
            font-size: 12px;
            color: #666;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #007bff;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .btn {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .btn-danger {
            background: #dc3545;
            color: #000000;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .produto-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .produto-info {
            flex: 1;
        }
        
        .produto-nome {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .produto-preco {
            color: #666;
            font-size: 14px;
        }
        
        .produto-preco-edit {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .produto-preco-edit input {
            width: 100px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        
        .produto-acoes {
            display: flex;
            gap: 5px;
        }
        
        .config-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            max-height: 90%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-medium { max-width: 600px; }
        .modal-large { max-width: 800px; }
        .modal-full { max-width: 95%; }
        .modal-wide { max-width: 500px; }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            margin: 0;
            font-size: 18px;
            font-weight: bold;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }
        
        .modal-close:hover {
            background: #f0f0f0;
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .produto-nome {
            font-weight: bold;
            color: #333;
        }
        
        .produto-preco {
            color: #666;
            font-size: 14px;
        }
        
        .pin-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .pin-input {
            width: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        
        .form-group input::placeholder {
            color: #999;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Configurações</h1>
        
        <div class="navigation">
            <a href="/">Registrar Venda</a>
            <a href="/relatorios">Admin</a>
            <a href="/configuracoes">Configurações</a>
        </div>
        
        <div id="messages"></div>
        
        <div class="config-section">
            <h3>Campos do Formulário</h3>
            <div id="fields-list">
                <!-- Campos serão carregados dinamicamente -->
            </div>
        </div>
        
        <div class="config-section">
            <h3>Produtos e Serviços</h3>
            <div style="margin-bottom: 15px;">
                <button class="btn" onclick="abrirModalGerenciarProdutos()">Editar Produtos/Serviços</button>
            </div>
            <div id="produto-form" style="display: none;">
                <div class="form-group">
                    <label for="produto-nome">Nome:</label>
                    <input type="text" id="produto-nome" placeholder="Digite o nome do produto/serviço">
                </div>
                <div class="form-group">
                    <label for="produto-preco">Preço (R$):</label>
                    <input type="number" id="produto-preco" step="0.01" min="0" placeholder="0.00">
                </div>
                <div>
                    <button class="btn btn-secondary" onclick="cancelarProduto()">Cancelar</button>
                    <button class="btn" onclick="salvarProdutoInline()">Salvar</button>
                </div>
            </div>
            <div id="produtos-list">
                <!-- Produtos serão carregados dinamicamente -->
            </div>
        </div>
        
        <div class="pin-section">
            <h3>PIN de Acesso ao Resumo</h3>
            <p>PIN atual: <span id="pin-status">Não definido</span></p>
            <div style="margin-bottom: 15px;">
                <button class="btn" onclick="abrirModalPin()">Alterar PIN</button>
            </div>
        </div>
        
        <div style="margin-top: 30px; text-align: center;">
            <button class="btn btn-secondary" onclick="restaurarPadroes()">Restaurar Padrões</button>
        </div>
    </div>

    <!-- Modal Overlay -->
    <div class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title"></h3>
                <button class="modal-close" onclick="fecharModal()">×</button>
            </div>
            <div class="modal-body">
                <!-- Conteúdo dinâmico -->
            </div>
            <div class="modal-footer">
                <!-- Botões dinâmicos -->
            </div>
        </div>
    </div>

    <script>
        // Sistema de Modais
        function abrirModal(titulo, conteudo, botoes = [], tamanho = 'medium') {
            const overlay = document.querySelector('.modal-overlay');
            const container = document.querySelector('.modal-container');
            const titleElement = container.querySelector('.modal-title');
            const bodyElement = container.querySelector('.modal-body');
            const footerElement = container.querySelector('.modal-footer');
            
            // Definir título (mostrar apenas se houver)
            if (titulo) {
                titleElement.textContent = titulo;
                titleElement.style.display = 'block';
            } else {
                titleElement.style.display = 'none';
            }
            
            // Definir conteúdo
            if (conteudo) {
                bodyElement.innerHTML = conteudo;
            }
            
            // Definir botões
            footerElement.innerHTML = '';
            botoes.forEach(botao => {
                const button = document.createElement('button');
                button.textContent = botao.text;
                button.className = botao.class || 'btn';
                if (botao.onclick) {
                    button.onclick = botao.onclick;
                }
                footerElement.appendChild(button);
            });
            
            // Definir tamanho
            container.className = 'modal-container';
            if (tamanho === 'large') {
                container.classList.add('large');
            }
            
            // Mostrar modal
            overlay.style.display = 'flex';
            document.body.style.overflow = 'hidden'; // Bloquear scroll do fundo
        }
        
        function fecharModal() {
            const overlay = document.querySelector('.modal-overlay');
            overlay.style.display = 'none';
            document.body.style.overflow = ''; // Restaurar scroll
        }
        
        function mostrarInformacao(titulo, mensagem) {
            abrirModal(titulo, `<p>${mensagem}</p>`, [
                { text: 'Ok', class: 'btn', onclick: () => fecharModal() }
            ]);
        }
        
        function confirmarAcao(titulo, mensagem, onConfirm) {
            abrirModal(titulo, `<p>${mensagem}</p>`, [
                { text: 'Cancelar', class: 'btn-secondary', onclick: () => fecharModal() },
                { text: 'Confirmar', class: 'btn', onclick: () => { onConfirm(); fecharModal(); } }
            ]);
        }

        // Configuração padrão dos campos
        const camposPadrao = [
            { id: 'cliente_nome', nome: 'Nome do Cliente', descricao: 'Busca e seleção de clientes', visivel: true },
            { id: 'produto_servico', nome: 'Produto/Serviço', descricao: 'Lista de produtos e serviços disponíveis', visivel: true },
            { id: 'observacoes', nome: 'Observações', descricao: 'Notas adicionais sobre a venda', visivel: true }
        ];

        let camposConfig = [];

        function carregarConfiguracoes() {
            // Carregar do localStorage ou usar padrão
            const salvos = localStorage.getItem('camposConfig');
            camposConfig = salvos ? JSON.parse(salvos) : [...camposPadrao];
            
            renderizarCampos();
            carregarProdutos();
            
            // Carregar PIN salvo
            carregarPinStatus();
        }

        function renderizarCampos() {
            const container = document.getElementById('fields-list');
            container.innerHTML = '';
            
            camposConfig.forEach(campo => {
                const fieldItem = document.createElement('div');
                fieldItem.className = 'field-item';
                
                fieldItem.innerHTML = `
                    <div class="field-info">
                        <div class="field-name">${campo.nome}</div>
                        <div class="field-description">${campo.descricao}</div>
                    </div>
                    <div class="field-controls">
                        <div>
                            <small>Visível</small>
                            <label class="toggle-switch">
                                <input type="checkbox" ${campo.visivel ? 'checked' : ''} 
                                       onchange="toggleCampo('${campo.id}', 'visivel', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                `;
                container.appendChild(fieldItem);
            });
        }

        function toggleCampo(campoId, propriedade, valor) {
            const campo = camposConfig.find(c => c.id === campoId);
            if (campo) {
                campo[propriedade] = valor;
                // Salvar automaticamente
                localStorage.setItem('camposConfig', JSON.stringify(camposConfig));
                showMessage('Configuração salva automaticamente!', 'success');
            }
        }

        function restaurarPadroes() {
            if (confirm('Tem certeza que deseja restaurar as configurações padrão?')) {
                camposConfig = [...camposPadrao];
                renderizarCampos();
                localStorage.removeItem('camposConfig');
                // Não remove mais o PIN do banco, apenas atualiza a interface
                carregarPinStatus();
                showMessage('Configurações restauradas com sucesso!', 'success');
            }
        }

        function carregarPinStatus() {
            fetch('/api/pin')
                .then(response => response.json())
                .then(data => {
                    if (data.pin) {
                        document.getElementById('pin-status').textContent = '●●●●';
                    } else {
                        document.getElementById('pin-status').textContent = 'Não definido';
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar PIN:', error);
                    document.getElementById('pin-status').textContent = 'Erro ao carregar';
                });
        }

        function showMessagePinForm(message, type) {
            const messagesDiv = document.getElementById('pin-form-messages');
            messagesDiv.innerHTML = '';
            
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;
            messagesDiv.appendChild(messageDiv);
            
            // Auto-remove após 5 segundos para sucesso, 10 para erro
            setTimeout(() => {
                messageDiv.remove();
            }, type === 'success' ? 5000 : 10000);
        }

        function abrirModalPin() {
            const modalBody = document.querySelector('.modal-body');
            const modalContent = `
                <div id="pin-form-messages"></div>
                <div class="form-group">
                    <label for="pin-atual">PIN Atual:</label>
                    <input type="password" id="pin-atual" placeholder="Digite o PIN atual" maxlength="4">
                </div>
                <div class="form-group">
                    <label for="pin-novo">Novo PIN:</label>
                    <input type="password" id="pin-novo" placeholder="Digite o novo PIN" maxlength="4">
                </div>
                <div class="form-group">
                    <label for="pin-confirmar">Confirmar Novo PIN:</label>
                    <input type="password" id="pin-confirmar" placeholder="Confirme o novo PIN" maxlength="4">
                </div>
            `;
            
            abrirModal('Alterar PIN', modalContent, [
                { text: 'Cancelar', class: 'btn-danger', onclick: () => fecharModal() },
                { text: 'Salvar', class: 'btn', onclick: () => salvarPinModal() }
            ], 'wide');
        }
        
        function salvarPinModal() {
            const pinAtual = document.getElementById('pin-atual').value;
            const pinNovo = document.getElementById('pin-novo').value;
            const pinConfirmar = document.getElementById('pin-confirmar').value;
            
            // Validações
            if (pinNovo.length !== 4 || !/^\d{4}$/.test(pinNovo)) {
                mostrarInformacao('Erro', 'Novo PIN deve ter exatamente 4 dígitos numéricos!');
                return;
            }
            
            if (pinNovo !== pinConfirmar) {
                mostrarInformacao('Erro', 'Confirmação do PIN não confere!');
                return;
            }
            
            // Verificar PIN atual se não for o primeiro cadastro
            if (pinAtual) {
                fetch('/api/pin/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        pin: pinAtual
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        mostrarInformacao('Erro', 'PIN atual incorreto!');
                        return;
                    }
                    // Se o PIN atual estiver correto, salvar o novo
                    salvarNovoPin(pinNovo);
                })
                .catch(error => {
                    mostrarInformacao('Erro', 'Erro ao verificar PIN atual: ' + error);
                });
            } else {
                // Se não há PIN atual, salvar direto
                salvarNovoPin(pinNovo);
            }
        }

        function salvarNovoPin(pinNovo) {
            fetch('/api/pin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    pin: pinNovo
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarInformacao('Sucesso', 'PIN atualizado com sucesso!');
                    fecharModal();
                    carregarPinStatus(); // Atualizar o PIN exibido
                } else {
                    mostrarInformacao('Erro', 'Erro ao salvar PIN: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                mostrarInformacao('Erro', 'Erro ao salvar PIN: ' + error);
            });
        }

        function abrirModalGerenciarProdutos() {
            carregarProdutosParaModal();
            abrirModal('Gerenciar Produtos e Serviços', '', [
                { text: 'Ok', class: 'btn', onclick: () => fecharModal() }
            ], 'large');
        }
        
        function carregarProdutosParaModal() {
            fetch('/api/produtos')
                .then(response => response.json())
                .then(data => {
                    renderizarModalProdutos(data);
                })
                .catch(error => {
                    console.error('Erro ao carregar produtos:', error);
                    mostrarInformacao('Erro', 'Não foi possível carregar os produtos');
                });
        }
        
        function renderizarModalProdutos(produtos) {
            const modalBody = document.querySelector('.modal-body');
            let html = `
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="abrirFormNovoProduto()">+ Adicionar Novo Produto</button>
                </div>
                <div id="form-novo-produto" style="display: none; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                    <h4>Novo Produto</h4>
                    <div class="form-group">
                        <label>Nome:</label>
                        <input type="text" id="novo-produto-nome" placeholder="Nome do produto/serviço" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                    </div>
                    <div class="form-group">
                        <label>Preço (R$):</label>
                        <input type="number" id="novo-produto-preco" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                    </div>
                    <div>
                        <button class="btn btn-secondary" onclick="cancelarNovoProduto()">Cancelar</button>
                        <button class="btn" onclick="salvarNovoProduto()">Salvar</button>
                    </div>
                </div>
                <div class="produtos-list">
            `;
            
            produtos.forEach(produto => {
                html += `
                    <div class="produto-item-modal" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px;">
                        <div class="produto-info" style="flex: 1;">
                            <div class="produto-nome" style="font-weight: bold; margin-bottom: 5px;">${produto.name}</div>
                            <div class="produto-preco-edit" id="preco-modal-${produto.id}">
                                <span class="produto-preco">R$ ${parseFloat(produto.price).toFixed(2)}</span>
                                <input type="number" class="produto-preco-input" step="0.01" min="0" value="${produto.price}" 
                                       style="display: none; width: 120px; padding: 5px; margin-left: 10px;"
                                       onblur="salvarPrecoModal(${produto.id}, this.value)"
                                       onkeypress="if(event.key==='Enter') salvarPrecoModal(${produto.id}, this.value)">
                            </div>
                        </div>
                        <div class="produto-acoes" style="display: flex; gap: 5px;">
                            <button class="btn btn-sm" onclick="editarPrecoModal(${produto.id}, ${produto.price})">Editar Preço</button>
                            <button class="btn btn-danger btn-sm" onclick="deletarProduto(${produto.id}, '${produto.name}')">Deletar</button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            modalBody.innerHTML = html;
        }
        
        function abrirFormNovoProduto() {
            const form = document.getElementById('form-novo-produto');
            if (form) {
                form.style.display = 'block';
                const nomeInput = document.getElementById('novo-produto-nome');
                if (nomeInput) nomeInput.focus();
            }
        }
        
        function cancelarNovoProduto() {
            const form = document.getElementById('form-novo-produto');
            if (form) {
                form.style.display = 'none';
            }
            const nomeInput = document.getElementById('novo-produto-nome');
            const precoInput = document.getElementById('novo-produto-preco');
            if (nomeInput) nomeInput.value = '';
            if (precoInput) precoInput.value = '';
        }
        
        function salvarNovoProduto() {
            const nomeInput = document.getElementById('novo-produto-nome');
            const precoInput = document.getElementById('novo-produto-preco');
            
            if (!nomeInput || !precoInput) {
                mostrarInformacao('Erro', 'Formulário não encontrado');
                return;
            }
            
            const nome = nomeInput.value.trim();
            const preco = precoInput.value;
            
            if (!nome) {
                mostrarInformacao('Erro', 'O nome do produto é obrigatório');
                return;
            }
            
            if (!preco || parseFloat(preco) <= 0) {
                mostrarInformacao('Erro', 'O preço deve ser maior que zero');
                return;
            }
            
            fetch('/api/produtos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: nome,
                    price: parseFloat(preco)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarInformacao('Sucesso', 'Produto adicionado com sucesso');
                    cancelarNovoProduto();
                    carregarProdutosParaModal();
                    carregarProdutos();
                } else {
                    mostrarInformacao('Erro', 'Erro ao adicionar produto: ' + data.error);
                }
            })
            .catch(error => {
                mostrarInformacao('Erro', 'Erro ao adicionar produto: ' + error);
            });
        }
        
        function editarPrecoModal(produtoId, precoAtual) {
            const precoElement = document.getElementById(`preco-modal-${produtoId}`);
            if (!precoElement) {
                mostrarInformacao('Erro', 'Elemento de preço não encontrado');
                return;
            }
            
            const precoSpan = precoElement.querySelector('.produto-preco');
            const precoInput = precoElement.querySelector('.produto-preco-input');
            
            if (!precoSpan || !precoInput) {
                mostrarInformacao('Erro', 'Campos de preço não encontrados');
                return;
            }
            
            if (precoInput.style.display === 'none' || !precoInput.style.display) {
                // Modo edição
                precoInput.value = precoAtual;
                precoInput.style.display = 'inline-block';
                precoSpan.style.display = 'none';
                precoInput.focus();
                precoInput.select();
            } else {
                // Modo visualização
                salvarPrecoModal(produtoId, precoInput.value);
            }
        }
        
        function salvarPrecoModal(produtoId, novoPreco) {
            const preco = parseFloat(novoPreco);
            
            if (isNaN(preco) || preco < 0) {
                mostrarInformacao('Erro', 'Preço inválido');
                return;
            }
            
            fetch(`/api/produtos/${produtoId}/preco`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    preco: preco
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarInformacao('Sucesso', 'Preço atualizado com sucesso');
                    carregarProdutosParaModal();
                    carregarProdutos();
                } else {
                    mostrarInformacao('Erro', 'Erro ao atualizar preço: ' + data.error);
                }
            })
            .catch(error => {
                mostrarInformacao('Erro', 'Erro ao atualizar preço: ' + error);
            });
        }
        
        function deletarProduto(produtoId, produtoNome) {
            if (confirm(`Tem certeza que deseja deletar o produto "${produtoNome}"?`)) {
                fetch(`/api/produtos/${produtoId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        mostrarInformacao('Sucesso', data.message || 'Produto removido com sucesso');
                        carregarProdutosParaModal();
                        carregarProdutos();
                    } else {
                        mostrarInformacao('Erro', 'Erro ao remover produto: ' + data.error);
                    }
                })
                .catch(error => {
                    mostrarInformacao('Erro', 'Erro ao remover produto: ' + error);
                });
            }
        }

        function carregarProdutos() {
            fetch('/api/produtos')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('produtos-list');
                    container.innerHTML = '';
                    
                    if (data.length === 0) {
                        container.innerHTML = '<p style="color: #666; text-align: center;">Nenhum produto cadastrado.</p>';
                        return;
                    }
                    
                    data.forEach(produto => {
                        const item = document.createElement('div');
                        item.className = 'produto-item';
                        item.innerHTML = `
                            <div class="produto-info">
                                <div class="produto-nome">${produto.name}</div>
                                <div class="produto-preco">R$ ${produto.price.toFixed(2)}</div>
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="deletarProduto(${produto.id})">×</button>
                        `;
                        container.appendChild(item);
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar produtos:', error);
                });
        }

        function salvarPinModal() {
            const pinAtual = document.getElementById('pin-atual').value;
            const pinNovo = document.getElementById('pin-novo').value;
            const pinConfirmar = document.getElementById('pin-confirmar').value;
            const pinSalvo = localStorage.getItem('pinResumo');
            
            // Validações
            if (pinSalvo && pinAtual !== pinSalvo) {
                showMessage('PIN atual incorreto!', 'error');
                return;
            }
            
            if (pinNovo.length !== 4 || !/^\d{4}$/.test(pinNovo)) {
                showMessage('Novo PIN deve ter exatamente 4 dígitos numéricos!', 'error');
                return;
            }
            
            if (pinNovo !== pinConfirmar) {
                showMessage('Confirmação do PIN não confere!', 'error');
                return;
            }
            
            // Salvar novo PIN
            localStorage.setItem('pinResumo', pinNovo);
            document.getElementById('pin-status').textContent = '●●●●';
            showMessage('PIN alterado com sucesso!', 'success');
            fecharModalPin();
        }

        function restaurarPadroes() {
            if (confirm('Tem certeza que deseja restaurar as configurações padrão?')) {
                camposConfig = [...camposPadrao];
                renderizarCampos();
                localStorage.removeItem('camposConfig');
                localStorage.removeItem('pinResumo');
                document.getElementById('pin-status').textContent = 'Não definido';
                showMessage('Configurações restauradas com sucesso!', 'success');
            }
        }

        function showMessage(message, type) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;
            messagesDiv.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Fechar modal ao clicar no overlay
        document.addEventListener('DOMContentLoaded', function() {
            const overlay = document.querySelector('.modal-overlay');
            if (overlay) {
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) {
                        fecharModal();
                    }
                });
            }
            
            // Fechar modal com ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const overlay = document.querySelector('.modal-overlay');
                    if (overlay && overlay.style.display === 'flex') {
                        fecharModal();
                    }
                }
            });
        });

        // Carregar configurações ao iniciar
        document.addEventListener('DOMContentLoaded', function() {
            carregarConfiguracoes();
            carregarProdutos();
        });
    </script>
</body>
</html>
